<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGNAL 9: THE DEAD AIR ARCHIVE</title>
  <link rel="stylesheet" href="css/style.css">

  <!-- A-Frame 1.5.0 -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- A-Frame Extras for locomotion -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>
  <!-- A-Frame Environment (for sky/ground) -->
  <!-- Note: Not using environment component to keep it custom -->
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════
     LOADING SCREEN
══════════════════════════════════════════════════════════════ -->
<div id="loading-screen">
  <h1>SIGNAL 9</h1>
  <p>THE DEAD AIR ARCHIVE</p>
  <p style="color:#444;font-size:0.65rem;margin-top:0.3rem;">WDRK-TV ◈ AUTHORIZED PERSONNEL ONLY</p>
  <div id="loading-bar"><div id="loading-fill"></div></div>
  <p id="loading-status" style="color:#444;font-size:0.75rem">INITIALIZING...</p>
  <button id="enter-button">◈ ENTER ARCHIVE</button>
  <p style="color:#222;font-size:0.6rem;margin-top:2rem">Use Meta Quest 3 or browser in desktop mode.<br>For full VR: open in Quest 3 browser, tap ⬜ to enter VR.</p>
</div>

<!-- ═══════════════════════════════════════════════════════════
     SUBTITLE DISPLAY (overlaid on 2D)
══════════════════════════════════════════════════════════════ -->
<div id="subtitle-display" style="
  position:fixed;bottom:10%;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.75);color:#e8d8a0;font-family:'Courier New',monospace;
  font-size:1rem;padding:0.5rem 1.5rem;border:1px solid #444;
  opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:9998;
  max-width:80%;text-align:center;letter-spacing:0.1em;
"></div>

<!-- ═══════════════════════════════════════════════════════════
     A-FRAME SCENE
══════════════════════════════════════════════════════════════ -->
<a-scene
  id="main-scene"
  vr-mode-ui="enabled: true"
  renderer="antialias: false; colorManagement: true; sortObjects: true; physicallyCorrectLights: false"
  shadow="type: pcfsoft"
  loading-screen="dotsColor: #cc2200; backgroundColor: #000000"
  background="color: #000000">

  <!-- Assets -->
  <a-assets timeout="30000">
    <img id="tex-static"  src="assets/textures/static.png" crossorigin="anonymous">
    <img id="tex-metal"   src="assets/textures/metal.png"  crossorigin="anonymous">
  </a-assets>

  <!-- ═══════════════════ PLAYER RIG ════════════════════════ -->
  <a-entity id="rig" position="0 0 2">

    <!-- Camera -->
    <a-entity
      id="player-camera"
      camera
      look-controls="pointerLockEnabled: false"
      wasd-controls="enabled: false"
      position="0 1.6 0">

      <!-- Comfort vignette (simple dark plane in front of camera) -->
      <a-entity id="vignette-overlay" visible="false">
        <a-ring
          position="0 0 -0.05"
          radius-inner="0.25"
          radius-outer="0.5"
          material="color:#000000;opacity:0.6;transparent:true;side:double;depthTest:false">
        </a-ring>
      </a-entity>

      <!-- In-world presence meter (diegetic HUD on camera) -->
      <a-entity position="0.2 -0.15 -0.4">
        <a-box width="0.08" height="0.04" depth="0.01" material="color:#000;opacity:0.9"></a-box>
        <a-entity id="presence-meter-display"
          text="value: SIGNAL 50%; align: center; color: #00ff00; width: 0.2"
          position="0 0 0.006">
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- ── LEFT HAND / CONTROLLER ──────────────────────────── -->
    <a-entity
      id="left-hand"
      hand-controls="hand: left; handModelStyle: lowPoly; color: #f2dec9"
      oculus-touch-controls="hand: left"
      position="0 0 0">
      <!-- Raycaster for menu interaction -->
      <a-entity
        raycaster="objects: .interactive; far: 5; showLine: true"
        line="color: #cc2200; opacity: 0.5">
      </a-entity>
    </a-entity>

    <!-- ── RIGHT HAND / CONTROLLER ─────────────────────────── -->
    <a-entity
      id="right-hand"
      hand-controls="hand: right; handModelStyle: lowPoly; color: #f2dec9"
      oculus-touch-controls="hand: right"
      position="0 0 0">
      <!-- Raycaster for menu interaction -->
      <a-entity
        raycaster="objects: .interactive; far: 5; showLine: true"
        line="color: #aa1100; opacity: 0.5">
      </a-entity>
    </a-entity>

  </a-entity>
  <!-- End Player Rig -->

  <!-- ═══════════════ LOCOMOTION COMPONENTS ═════════════════ -->
  <!-- Teleport locomotion via blink -->
  <a-entity
    id="teleport-target"
    geometry="primitive: ring; radiusInner: 0.2; radiusOuter: 0.25"
    material="color: #00ff00; shader: flat"
    position="0 0.01 0"
    visible="false">
  </a-entity>

  <!-- ═══════════════ WRIST MENU ════════════════════════════ -->
  <a-entity
    id="wrist-menu-entity"
    wrist-menu
    visible="false"
    position="0 0 0">
    <!-- Attach to left wrist (will be moved via JS) -->
    <a-box width="0.25" height="0.15" depth="0.01" material="color:#0a0a0a;opacity:0.95;transparent:true"></a-box>
    <a-text value="WRIST MENU" align="center" color="#cc8866" width="0.8" position="0 0.04 0.01"></a-text>
    <a-text id="wrist-mission" value="MISSION: 0" align="center" color="#666" width="0.6" position="0 0 0.01"></a-text>
    <a-text id="wrist-signal" value="SIGNAL: 50%" align="center" color="#00ff00" width="0.6" position="0 -0.04 0.01"></a-text>
  </a-entity>

  <!-- ═══════════════ COMPLIANCE CHECKLIST ═════════════════ -->
  <a-entity
    id="checklist-display"
    compliance-checklist
    visible="false"
    position="0 1.4 -0.6">
    <a-box width="0.6" height="0.8" depth="0.01" material="color:#e8d8a0;opacity:0.97"></a-box>
    <a-text
      value="COMPLIANCE CHECKLIST&#10;&#10;If tone ≠ 1000Hz,&#10;  do not acknowledge it.&#10;If you hear your name,&#10;  say STATION ID ONLY.&#10;If light turns BLUE,&#10;  look at floor.&#10;Complete all segments.&#10;SIGNAL 9 MUST AIR."
      align="left"
      color="#333"
      width="1.2"
      wrap-count="30"
      position="-0.25 0.3 0.01">
    </a-text>
  </a-entity>

  <!-- SCENE ROOT IS INJECTED HERE BY JS -->

</a-scene>

<!-- ═══════════════════════════════════════════════════════════
     SCRIPTS
══════════════════════════════════════════════════════════════ -->
<script src="js/game.js"></script>
<script src="js/scenes.js"></script>

<script>
// ═══════════════════════════════════════════════════════════
// INITIALIZATION
// ═══════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
  // Init save data
  SIGNAL9.gameData = SIGNAL9.Save.load();
  SIGNAL9.currentMission = SIGNAL9.gameData.currentMission || 0;

  // Start loading screen sequence
  SIGNAL9.showLoading();

  // Scene loaded event
  const scene = document.querySelector('a-scene');
  scene.addEventListener('loaded', () => {
    console.log('[SIGNAL9] A-Frame scene loaded');

    // Attach locomotion to rig
    const rig = document.getElementById('rig');
    rig.setAttribute('smooth-locomotion', 'speed: 3');
    rig.setAttribute('snap-turn', 'angle: 30');

    // Set up controller button listeners
    setupControllerButtons();

    // Wrist menu tick update
    setInterval(updateWristMenu, 500);
  });

  // Prevent context menu in VR
  document.addEventListener('contextmenu', e => e.preventDefault());
});

// ═══════════════════════════════════════════════════════════
// CONTROLLER BUTTON SETUP
// ═══════════════════════════════════════════════════════════
function setupControllerButtons() {
  const leftCtrl  = document.getElementById('left-hand');
  const rightCtrl = document.getElementById('right-hand');
  if (!leftCtrl || !rightCtrl) return;

  // Y button - vignette toggle
  leftCtrl.addEventListener('ybuttondown', () => {
    const vign = document.getElementById('vignette-overlay');
    if (vign) {
      const vis = vign.getAttribute('visible');
      vign.setAttribute('visible', vis === 'true' ? 'false' : 'true');
    }
  });

  // X button - compliance checklist
  leftCtrl.addEventListener('xbuttondown', () => {
    const cl = document.getElementById('checklist-display');
    if (cl) {
      const vis = cl.getAttribute('visible');
      cl.setAttribute('visible', vis === 'true' ? 'false' : 'true');
      // Position near player camera
      const cam = document.getElementById('player-camera');
      if (cam) {
        const pos = cam.getAttribute('position') || {x:0,y:1.6,z:0};
        const rig = document.getElementById('rig');
        const rpos = rig.getAttribute('position') || {x:0,y:0,z:0};
        cl.setAttribute('position', `${rpos.x} ${pos.y} ${rpos.z - 0.6}`);
      }
    }
  });

  // A button - wrist menu
  rightCtrl.addEventListener('abuttondown', () => {
    const wm = document.getElementById('wrist-menu-entity');
    if (wm) {
      const vis = wm.getAttribute('visible');
      wm.setAttribute('visible', vis === 'true' ? 'false' : 'true');
    }
  });

  // B button - back / close any open panels
  rightCtrl.addEventListener('bbuttondown', () => {
    const panels = ['settings-panel','credits-panel','checklist-display','wrist-menu-entity'];
    panels.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.setAttribute('visible','false');
    });
  });

  // Trigger - raycaster click
  rightCtrl.addEventListener('triggerdown', () => {
    triggerRayClick(rightCtrl);
  });
  leftCtrl.addEventListener('triggerdown', () => {
    triggerRayClick(leftCtrl);
  });
}

function triggerRayClick(ctrlEl) {
  const raycaster = ctrlEl.components && ctrlEl.components['raycaster'];
  if (!raycaster) return;
  const intersected = raycaster.intersectedEls;
  if (intersected && intersected.length > 0) {
    const target = intersected[0];
    target.emit('triggerdown', null, false);
    target.emit('click', null, false);
  }
}

function updateWristMenu() {
  const wm = document.getElementById('wrist-mission');
  const ws = document.getElementById('wrist-signal');
  if (wm) wm.setAttribute('text', `value:MISSION: ${SIGNAL9.currentMission};align:center;color:#888;width:0.6`);
  if (ws) {
    const v = SIGNAL9.Presence.value;
    ws.setAttribute('text', `value:SIGNAL: ${v}%;align:center;color:${v>60?'#00ff00':v>30?'#ffaa00':'#ff4400'};width:0.6`);
  }

  // Attach checklist to left wrist when visible
  const cl = document.getElementById('checklist-display');
  const leftHand = document.getElementById('left-hand');
  if (cl && leftHand && cl.getAttribute('visible') === 'true') {
    const handPos = new THREE.Vector3();
    leftHand.object3D.getWorldPosition(handPos);
    cl.setAttribute('position', `${handPos.x} ${handPos.y+0.15} ${handPos.z}`);
  }
}

// ═══════════════════════════════════════════════════════════
// KEYBOARD FALLBACK (Desktop testing)
// ═══════════════════════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  switch(e.key) {
    case '1': SIGNAL9.Scenes.load(1); break;
    case '2': SIGNAL9.Scenes.load(2); break;
    case '3': SIGNAL9.Scenes.load(3); break;
    case '4': SIGNAL9.Scenes.load(4); break;
    case '5': SIGNAL9.Scenes.load(5); break;
    case '6': SIGNAL9.Scenes.load(6); break;
    case '0': SIGNAL9.Scenes.load(0); break;
    case 'c':
      const cl = document.getElementById('checklist-display');
      if (cl) cl.setAttribute('visible', cl.getAttribute('visible') === 'true' ? 'false' : 'true');
      break;
    case 'm':
      const wm = document.getElementById('wrist-menu-entity');
      if (wm) wm.setAttribute('visible', wm.getAttribute('visible') === 'true' ? 'false' : 'true');
      break;
  }
});

// ═══════════════════════════════════════════════════════════
// AUDIO CONTEXT RESUME on any click (browser policy)
// ═══════════════════════════════════════════════════════════
document.addEventListener('click', () => {
  if (SIGNAL9.Audio.ctx) SIGNAL9.Audio.resume();
}, { once: false });
</script>

</body>
</html>
